<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.1"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/tiger.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/tiger.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"ziveni.github.io",root:"/",scheme:"Pisces",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"mac"},back2top:{enable:!0,sidebar:!0,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="redis在linux下的安装部署，哨兵模式，集群模式"><meta property="og:type" content="article"><meta property="og:title" content="redis安装部署指南"><meta property="og:url" content="https://ziveni.github.io/2022/02/17/redis%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97/index.html"><meta property="og:site_name" content="Ziveni"><meta property="og:description" content="redis在linux下的安装部署，哨兵模式，集群模式"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://gitee.com/zvenw/pics/raw/master/img/20220216165130-16450909237438.png"><meta property="article:published_time" content="2022-02-17T09:37:26.000Z"><meta property="article:modified_time" content="2022-02-17T09:51:02.102Z"><meta property="article:author" content="ziveni"><meta property="article:tag" content="Linux"><meta property="article:tag" content="redis"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://gitee.com/zvenw/pics/raw/master/img/20220216165130-16450909237438.png"><link rel="canonical" href="https://ziveni.github.io/2022/02/17/redis%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>redis安装部署指南 | Ziveni</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?6a658b485be6ecfccb3955d2d8c592b1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="Ziveni" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">Ziveni</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">网站副标题</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">2</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">1</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">1</span></a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="reading-progress-bar"></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://ziveni.github.io/2022/02/17/redis%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/uploads/avatar.png"><meta itemprop="name" content="ziveni"><meta itemprop="description" content="网站描述"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Ziveni"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">redis安装部署指南</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-02-17 17:37:26 / 修改时间：17:51:02" itemprop="dateCreated datePublished" datetime="2022-02-17T17:37:26+08:00">2022-02-17</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a> </span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h3 id="redis在linux下的安装部署，哨兵模式，集群模式"><a href="#redis在linux下的安装部署，哨兵模式，集群模式" class="headerlink" title="redis在linux下的安装部署，哨兵模式，集群模式"></a>redis在linux下的安装部署，哨兵模式，集群模式</h3><span id="more"></span><h1 id="一、redis安装"><a href="#一、redis安装" class="headerlink" title="一、redis安装"></a>一、redis安装</h1><blockquote><p>redis官网：<a target="_blank" rel="noopener" href="https://redis.io/download">https://redis.io/download</a></p><p>注：如果没有特殊版本要求，在centos下可以直接 <code>yum install -y redis</code> 此版本3</p></blockquote><h2 id="1-下载并解压"><a href="#1-下载并解压" class="headerlink" title="1. 下载并解压"></a>1. 下载并解压</h2><ul><li><p>目前最新稳定版本为6.2.4</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 直接下载到/data</span></span><br><span class="line">wget https://download.redis.io/releases/redis-6.2.4.tar.gz -O /data/redis.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.解压并重命名</span></span><br><span class="line"><span class="built_in">mkdir</span> /data/redis &amp;&amp; tar -zxvf /data/redis.tar.gz -C /data/redis --strip-components 1</span><br></pre></td></tr></table></figure></li></ul><h2 id="2-编译"><a href="#2-编译" class="headerlink" title="2. 编译"></a>2. 编译</h2><ul><li><p>安装到/data/redis里，方便管理</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 进入到源码包里</span></span><br><span class="line"><span class="built_in">cd</span> /data/redis</span><br><span class="line"><span class="comment"># 2. 编译并安装 PREFIX=指定程序存放的路径</span></span><br><span class="line">make &amp;&amp; make PREFIX=/data/redis install</span><br></pre></td></tr></table></figure></li></ul><h2 id="3-修改配置文件"><a href="#3-修改配置文件" class="headerlink" title="3. 修改配置文件"></a>3. 修改配置文件</h2><ul><li>不建议使用<code>utils/install_server.sh</code>进行配置</li></ul><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 修改redis配置文件</span></span><br><span class="line"><span class="attr">vim</span> <span class="string">/data/redis/redis.conf</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 2. 将daemonize no 改为yes代表后台运行</span></span><br><span class="line"><span class="attr">daemonize</span> <span class="string">yes</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 3.修改pid的名称</span></span><br><span class="line"><span class="attr">pidfile</span> <span class="string">/var/run/redis.pid</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 4.记录log</span></span><br><span class="line"><span class="attr">logfile</span> <span class="string">&quot;/data/redis/redis.log&quot;</span></span><br></pre></td></tr></table></figure><h2 id="4-添加开机启动"><a href="#4-添加开机启动" class="headerlink" title="4. 添加开机启动"></a>4. 添加开机启动</h2><ul><li>redis自带有脚本 <code>utils/redis_init_script</code> ,如果是按照文档上文安装的此处需要修改一下</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 修改以下选项</span></span><br><span class="line"><span class="comment"># 配置实际路径</span></span><br><span class="line">EXEC=/data/redis/bin/redis-server</span><br><span class="line">CLIEXEC=/data/redis/bin/redis-cli</span><br><span class="line">CONF=<span class="string">&quot;/data/redis/redis.conf&quot;</span></span><br><span class="line">PIDFILE=/var/run/redis.pid</span><br><span class="line"></span><br><span class="line"><span class="comment">#============================= 非必要  =============================</span></span><br><span class="line"><span class="comment"># 如果更改了端口号 请在脚本中也做出修改</span></span><br><span class="line">REDISPORT=16379</span><br><span class="line"><span class="comment">#如果你使用了密码验证 请修改此脚本，增加密码 在stop中增加-a</span></span><br><span class="line">PASSWD=Abc.123</span><br><span class="line"><span class="variable">$CLIEXEC</span> -p <span class="variable">$REDISPORT</span> -a <span class="variable">$PASSWD</span> shutdown</span><br><span class="line"><span class="comment">#============================= end  =============================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 复制脚本文件</span></span><br><span class="line"><span class="built_in">cp</span> /data/redis/utils/redis_init_script /etc/init.d/redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 开机自启</span></span><br><span class="line">chkconfig redis on</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.启动 | 关闭 | 检查</span></span><br><span class="line">systemctl start | stop | status redis</span><br><span class="line"><span class="comment"># 或 service管理</span></span><br></pre></td></tr></table></figure><h2 id="5-redis-conf-几个重要配置"><a href="#5-redis-conf-几个重要配置" class="headerlink" title="5. redis.conf 几个重要配置"></a>5. redis.conf 几个重要配置</h2><table><thead><tr><th>配置项名称</th><th>配置项值范围</th><th>说明</th></tr></thead><tbody><tr><td>daemonize</td><td>yes、no</td><td>yes表示启用守护进程，默认是no即不以守护进程方式运行。其中Windows系统下不支持启用守护进程方式运行</td></tr><tr><td>port</td><td>默认端口为 6379</td><td>指定 Redis 监听端口，</td></tr><tr><td>bind</td><td>默认127.0.0.1</td><td>绑定的主机地址,如果需要设置远程访问则直接将这个属性备注下或者改为bind * 即可,这个属性和下面的protected-mode控制了是否可以远程访问 。</td></tr><tr><td>protected-mode</td><td>yes 、no</td><td>保护模式，该模式控制外部网是否可以连接redis服务，默认是yes,所以默认我们外网是无法访问的，如需外网连接rendis服务则需要将此属性改为no。</td></tr><tr><td>timeout</td><td>300</td><td>当客户端闲置多长时间后关闭连接，如果指定为 0，表示关闭该功能</td></tr><tr><td>loglevel</td><td>debug、verbose、notice、warning</td><td>日志级别，默认为 notice</td></tr><tr><td>databases</td><td>16</td><td>设置数据库的数量，默认的数据库是0。整个通过客户端工具可以看得到</td></tr><tr><td>rdbcompression</td><td>yes、no</td><td>指定存储至本地数据库时是否压缩数据，默认为 yes，Redis 采用 LZF 压缩，如果为了节省 CPU 时间，可以关闭该选项，但会导致数据库文件变的巨大。</td></tr><tr><td>dbfilename</td><td>dump.rdb</td><td>指定本地数据库文件名，默认值为 dump.rdb</td></tr><tr><td>dir</td><td></td><td>指定本地数据库存放目录</td></tr><tr><td>requirepass</td><td></td><td>设置 Redis 连接密码，如果配置了连接密码，客户端在连接 Redis 时需要通过 AUTH<password>命令提供密码，默认关闭</password></td></tr><tr><td>maxclients</td><td>0</td><td>设置同一时间最大客户端连接数，默认无限制，Redis 可以同时打开的客户端连接数为 Redis 进程可以打开的最大文件描述符数，如果设置 maxclients 0，表示不作限制。当客户端连接数到达限制时，Redis 会关闭新的连接并向客户端返回 max number of clients reached 错误信息。</td></tr><tr><td>maxmemory</td><td>XXX<bytes></bytes></td><td>指定 Redis 最大内存限制，Redis 在启动时会把数据加载到内存中，达到最大内存后，Redis 会先尝试清除已到期或即将到期的 Key，当此方法处理 后，仍然到达最大内存设置，将无法再进行写入操作，但仍然可以进行读取操作。Redis 新的 vm 机制，会把 Key 存放内存，Value 会存放在 swap 区。配置项值范围列里XXX为数值。</td></tr></tbody></table><h2 id="7-两个警告处理"><a href="#7-两个警告处理" class="headerlink" title="7. 两个警告处理"></a>7. 两个警告处理</h2><ol><li><p>WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</p><ul><li><p>原因：对一个高负载的环境来说tcp设置128这个值，太小了</p></li><li><p>解决办法</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑sysctl.conf</span></span><br><span class="line"><span class="attr">vim</span> <span class="string">/etc/sysctl.conf</span></span><br><span class="line"><span class="comment"># 增加以下内容</span></span><br><span class="line"><span class="attr">net.core.somaxconn</span>=<span class="string">1024</span></span><br><span class="line"><span class="comment">#立即生效</span></span><br><span class="line"><span class="attr">sysctl</span> <span class="string">-p</span></span><br></pre></td></tr></table></figure></li><li><p>补充</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">net.core.somaxconn 介绍</span><br><span class="line">1）概念介绍</span><br><span class="line">  对于一个TCP链接，Server与Client需要通过三次握手来建立网络链接，当三次握手成功之后，我们就可以看到端口状态由LISTEN转为ESTABLISHED，接着这条链路上就可以开始传送数据了</span><br><span class="line"></span><br><span class="line">net.core.somaxconn是Linux中的一个内核(kernel)参数，表示socket监听(listen)的backlog上限。</span><br><span class="line">什么是backlog？backlog就是socket的监听队列，当一个请求(request)尚未被处理或者建立时，它就会进入backlog。</span><br><span class="line">而socket server可以一次性处理backlog中的所有请求，处理后的请求不再位于监听队列中。</span><br><span class="line">当Server处理请求较慢时，导致监听队列被填满后，新来的请求就会被拒绝。</span><br><span class="line"></span><br><span class="line">2）补充</span><br><span class="line">Linux系统中，该参数的值默认是128</span><br><span class="line">如果Linux系统中部署了经常处理新请求(request)的高负载的服务，那么显然这个值是需要增加到更合适的值的</span><br></pre></td></tr></table></figure></li></ul></li><li><p>WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add ‘vm.overcommit_memory = 1’ to /etc/sysctl.conf and then reboot or run the command ‘sysctl vm.overcommit_memory=1’ for this to take effect.</p><ul><li><p>原因：警告overcommit_memory设置为0! 在内存不足的情况下，后台保存可能失败</p></li><li><p>解决办法</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># </span><span class="language-bash">编辑sysctl.conf</span></span><br><span class="line">vim /etc/sysctl.conf</span><br><span class="line"><span class="meta"># </span><span class="language-bash">增加以下内容</span></span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line"><span class="meta">#</span><span class="language-bash">立即生效</span></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure></li><li><p>补充</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">overcommit<span class="built_in">_</span>memory有什么作用？  </span><br><span class="line">     overcommit<span class="built_in">_</span>memory取值又三种分别为0， 1， 2</span><br><span class="line"></span><br><span class="line">    overcommit<span class="built_in">_</span>memory=0， 表示内核将检查是否有足够的可用内存供应用进程使用；如果有足够的可用内存，内存申请允许；否则，内存申请失败，并把错误返回给应用进程。</span><br><span class="line">    overcommit<span class="built_in">_</span>memory=1， 表示内核允许分配所有的物理内存，而不管当前的内存状态如何。</span><br><span class="line">    overcommit<span class="built_in">_</span>memory=2， 表示内核允许分配超过所有物理内存和交换空间总和的内存</span><br></pre></td></tr></table></figure></li></ul></li></ol><h1 id="二、redis主从"><a href="#二、redis主从" class="headerlink" title="二、redis主从"></a>二、redis主从</h1><blockquote><p>master: 192.168.85.107 16379</p><p>slave: 192.168.85.115 16380</p><p>slave: 192.168.85.106 16381</p></blockquote><ul><li><p>主从复制模式中，主要是从节点配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">slaveof 192.168.85.107 16379  #作为192.168.1.100这台服务器的从服务器  在6版本之前为replicof</span><br><span class="line"></span><br><span class="line">replica-read-only   yes  #从服务器只读，写操作在主服务器上，实现读写分离</span><br><span class="line"></span><br><span class="line">repl-timeout 60 #从库复制超时时间，数据很多的话需要调长，否则主从会断开</span><br><span class="line"></span><br><span class="line">repl-backlog-size 1M #从服务离线之后，主服务器会把离线之后的写入命令存储在一个特定大小的队列中，避免短时间断开服务却进行全量同步的问题</span><br><span class="line"></span><br><span class="line">repl-diskless-sync yes #开启无盘复制，主从全量同步时，主库并不会在本地创建RDB 文件，而是创建一个子进程通过Socket将RDB文件写入到从服务器，节约IO资源</span><br><span class="line"></span><br><span class="line">client-output-buffer-limit replica 256mb 64mb 60  #客户端输出缓冲区配置。每个客户端连接（包括从库）后都会申请一个buffer空间，通过该选项限制可以避免buffer持续增长消耗内存。如果超过限制主库会强制断开连接，也就是说从库处理慢导致主库buffer积压达到限制后主库会强制断开从库的连接，此时主从复制会中断，中断后如果从库再次发起复制请求还会继续被断开导致恶性循环，引发复制风暴。调为0则不限制，</span><br><span class="line"><span class="meta">#</span><span class="language-bash">大小限制是256M，持续性限制是当客户端缓冲区大小持续60秒超过64M，则关闭客户端连接。</span></span><br><span class="line"><span class="meta">#</span><span class="language-bash">client-output-buffer-limit normal 0 0 0</span></span><br><span class="line"><span class="meta">#</span><span class="language-bash">client-output-buffer-limit replica 256mb 64mb 60</span></span><br><span class="line"><span class="meta">#</span><span class="language-bash">client-output-buffer-limit pubsub 8mb 2mb 60</span></span><br><span class="line"></span><br><span class="line">masterauth 123456789  #主库如果配置了密码，这里需要配置正确的密码</span><br></pre></td></tr></table></figure></li><li><p>查看是否成功</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入redis-cli客户端查看</span></span><br><span class="line">info replication</span><br></pre></td></tr></table></figure></li><li><p>当master挂掉之后，可以使用以下命令让slave成为master</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SLAVEOF NO ONE</span><br></pre></td></tr></table></figure></li></ul><h1 id="三、哨兵模式"><a href="#三、哨兵模式" class="headerlink" title="三、哨兵模式"></a>三、哨兵模式</h1><p><img src="https://gitee.com/zvenw/pics/raw/master/img/20220216165130-16450909237438.png"></p><blockquote><p>1.每个Sentinel进程以每秒钟一次的频率向整个集群中的Master主服务器，Slave从服务器以及其他Sentinel进程发送一个 PING 命令。<br>2.如果一个实例（instance）距离最后一次有效回复 PING 命令的时间超过 down-after-milliseconds 选项所指定的值， 则这个实例会被Sentinel进程标记为SDOWN。<br>3.如果一个Master主服务器被标记为SDOWN，则正在监视这个Master主服务器的所有 Sentinel进程要以每秒一次的频率确认Master主服务器的确进入了主观下线状态。<br>4.当有足够数量的Sentinel进程（大于等于配置文件指定的值）在指定的时间范围内确认Master主服务器进入了SDOWN， 则Master主服务器会被标记为客观下线ODOWN。<br>5.在一般情况下， 每个Sentinel进程会以每10 秒一次的频率向集群中的所有Master主服务器、Slave从服务器发送INFO命令。<br>当Master主服务器被Sentinel进程标记为ODOWN时，Sentinel进程向下线的Master主服务器的所有Slave从服务器发送INFO命令的频率会从 10 秒一次改为每秒一次。<br>6.若没有足够数量的Sentinel进程同意 Master主服务器下线， Master主服务器的客观下线状态就会被移除。若Master主服务器重新向Sentinel进程发送 PING 命令返回有效回复，Master主服务器的主观下线状态就会被移除。</p></blockquote><h2 id="3-1-配置"><a href="#3-1-配置" class="headerlink" title="3.1 配置"></a>3.1 配置</h2><ul><li>基于主从增加sentinel.conf 配置 节点为奇数，文档中使用了三个sentinel节点，每个节点都需要配置，主要不同为端口号</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">port 26379</span><br><span class="line">dir &quot;/data/redis/26379&quot;</span><br><span class="line">logfile &quot;/data/redis/redis-sentinel.log&quot;</span><br><span class="line"><span class="meta">#</span><span class="language-bash">配置主节点的IP和端口，2代表主节点判断失败至少需要2个Sentinel节点同意，一般设置为Sentinel节点数的一半加1.</span></span><br><span class="line">sentinel monitor mymaster 192.168.85.106 6379 2</span><br><span class="line"><span class="meta">#</span><span class="language-bash">30秒ping不通主节点的信息，主观认为master宕机</span></span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line"><span class="meta">#</span><span class="language-bash">故障转移时从节点同时向新主发起复制请求的数量，1代表从节点会轮询发起复制。</span></span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line"><span class="meta">#</span><span class="language-bash">故障转移开始，180秒内没有完成，则认为转移失败</span></span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br></pre></td></tr></table></figure><h2 id="3-2-启动并测试"><a href="#3-2-启动并测试" class="headerlink" title="3.2 启动并测试"></a>3.2 启动并测试</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动 /data/redis/bin</span></span><br><span class="line">./redis-sentinel ../sentinel.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看哨兵状态 -p 端口为哨兵节点的端口</span></span><br><span class="line">./redis-cli -p 26379</span><br><span class="line"></span><br><span class="line">$ 127.0.0.1:26379&gt; info sentinel</span><br><span class="line"><span class="comment"># Sentinel</span></span><br><span class="line">sentinel_masters:1</span><br><span class="line">sentinel_tilt:0</span><br><span class="line">sentinel_running_scripts:0</span><br><span class="line">sentinel_scripts_queue_length:0</span><br><span class="line">sentinel_simulate_failure_flags:0</span><br><span class="line">master0:name=mymaster,status=ok,address=127.0.0.1:6379,slaves=0,sentinels=3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 同时可查看106 107的redis.conf配置文件发生变化  107的sentinel配置文件也发生了变化 </span></span><br></pre></td></tr></table></figure><ul><li>测试故障转移</li></ul><blockquote><p>故障转移的大体步骤如下：</p><ol><li>每个Sentinel节点每隔1秒对主、从、其他Sentinel阶段发送ping探测，超过down-after-milliseconds未返回响应，则判断该节点主观下线。</li><li>Sentinel节点向其他Sentinel节点询问对于异常节点的判断，当达到 quorum个sentinel节点都认为被主观下线的节点异常时，则对该节点做客观下线。</li><li>在sentinel节点中通过Raft算法选举出一个leader来完成故障转移。</li><li>当出现故障的节点是主节点时，sentinel leader会根据优先级、复制偏移量、runid等在从节点中选出一个作为主节点，执行slaveof no one命令。</li><li>leader向其他从节点发送指令，让他们成为新主的从节点，并将原来的主节点更新为从节点，当旧主恢复后去复制新主的数据。</li><li>复制完成后，发布主节点的切换消息。</li></ol></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. kill 掉 106 master进程</span></span><br><span class="line"><span class="built_in">kill</span> -9 5677</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 查看转移情况 -- master转移到107上</span></span><br><span class="line"><span class="variable">$127</span>.0.0.1:26379&gt; info sentinel</span><br><span class="line"><span class="comment"># Sentinel</span></span><br><span class="line">sentinel_masters:1</span><br><span class="line">sentinel_tilt:0</span><br><span class="line">sentinel_running_scripts:0</span><br><span class="line">sentinel_scripts_queue_length:0</span><br><span class="line">sentinel_simulate_failure_flags:0</span><br><span class="line">master0:name=mymaster,status=ok,address=192.168.85.107:6380,slaves=2,sentinels=3</span><br><span class="line"></span><br><span class="line">127.0.0.1:6380&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=192.168.85.115,port=6381,state=online,offset=129383,lag=0</span><br><span class="line">slave1:ip=192.168.85.106,port=6379,state=online,offset=129383,lag=1</span><br><span class="line">master_replid:782dc289609fee05ac15e618dbc1d99c1180484d</span><br><span class="line">master_replid2:755d8165585452a9ed4d03aef0d0522bf6e8290b</span><br><span class="line">master_repl_offset:129669</span><br><span class="line">second_repl_offset:35062</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:3823</span><br><span class="line">repl_backlog_histlen:125847</span><br></pre></td></tr></table></figure><h1 id="四、-集群"><a href="#四、-集群" class="headerlink" title="四、 集群"></a>四、 集群</h1><blockquote><p><strong>Redis集群(Redis Cluster)</strong> 是Redis提供的分布式数据库方案，通过 <strong>分片(sharding)</strong> 来进行数据共享，并提供复制和故障转移功能。相比于主从复制、哨兵模式，Redis集群实现了较为完善的高可用方案，解决了存储能力受到单机限制，写操作无法负载均衡的问题。</p></blockquote><ul><li>集群的搭建可以分为四步：</li></ul><ol><li><p>启动节点：将节点以集群方式启动，此时节点是独立的。</p></li><li><p>节点握手：将独立的节点连成网络。</p><p>2.1. 在redis5之前需要使用CLUSTER MEET</p></li><li><p>槽指派：将16384个槽位分配给主节点，以达到分片保存数据库键值对的效果。</p><p>3.1. Redis集群通过分片(sharding)的方式保存数据库的键值对，整个数据库被分为16384个槽(slot)，数据库每个键都属于这16384个槽的一个，集群中的每个节点都可以处理0个或者最多16384个slot。</p><p>3.2 槽是数据管理和迁移的基本单位。当数据库中的16384个槽都分配了节点时，集群处于上线状态（ok）；如果有任意一个槽没有分配节点，则集群处于下线状态（fail）</p><p>3.3 CLUSTER ADDSLOTS redis5之前需要手动指定</p></li><li><p>主从复制：为从节点指定主节点。redis5之前需要CLUSTER REPLICATE<node_id></node_id></p></li></ol><table><thead><tr><th align="center">IP</th><th align="center">PORT（master）</th><th align="center">port（slave）</th></tr></thead><tbody><tr><td align="center">192.168.85.106</td><td align="center">6379（16379）</td><td align="center">26379（36379）</td></tr><tr><td align="center">192.168.85.107</td><td align="center">6380（16380）</td><td align="center">26380（36380）</td></tr><tr><td align="center">192.168.85.115</td><td align="center">6381（16381）</td><td align="center">26381（36381）</td></tr></tbody></table><h2 id="4-1-安装redis"><a href="#4-1-安装redis" class="headerlink" title="4.1  安装redis"></a>4.1 安装redis</h2><ol><li><p>按照redis编译安装</p></li><li><p>基础配置</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 在每个节点上创建以下内容 分别存放配置文件  日志 pid  数据</span></span><br><span class="line"><span class="built_in">cd</span> /data/redis</span><br><span class="line"><span class="built_in">mkdir</span> conf <span class="built_in">log</span> run data  </span><br><span class="line"><span class="comment"># 106中</span></span><br><span class="line"><span class="built_in">mkdir</span> -p data/6379 data/26379</span><br><span class="line"><span class="comment"># 107中</span></span><br><span class="line"><span class="built_in">mkdir</span> -p data/6380 data/26380</span><br><span class="line"><span class="comment"># 115</span></span><br><span class="line"><span class="built_in">mkdir</span> -p data/6381 data/26381</span><br></pre></td></tr></table></figure></li></ol><h2 id="4-2-配置节点"><a href="#4-2-配置节点" class="headerlink" title="4.2 配置节点"></a>4.2 配置节点</h2><ol><li><p>先配置6379节点，后续直接复制修改即可</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一 、复制redis.conf</span></span><br><span class="line"><span class="built_in">cp</span> /data/redis/redis.conf conf/redis_6379.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改以下内容</span></span><br><span class="line"><span class="comment"># 二、允许远程访问</span></span><br><span class="line"><span class="comment">#1. 注释掉下面代码，或者改为 bind 0.0.0.0</span></span><br><span class="line"><span class="built_in">bind</span> 0.0.0.0</span><br><span class="line"><span class="comment">#2. 关闭保护模式</span></span><br><span class="line">protected-mode no</span><br><span class="line"></span><br><span class="line"><span class="comment"># 二.通用配置</span></span><br><span class="line"><span class="comment">#1. 开启守护进程</span></span><br><span class="line">daemonize <span class="built_in">yes</span></span><br><span class="line"><span class="comment">#2. 配置密码（必须设置相同的密码，不设masterauth的话宕机了不能自动恢复）</span></span><br><span class="line"><span class="comment">#requirepass tdfdsfnkinki.net</span></span><br><span class="line"><span class="comment">#集群节点间的访问密码</span></span><br><span class="line"><span class="comment">#masterauth tdfdsfnkinki.net</span></span><br><span class="line"><span class="comment"># 持久化类型</span></span><br><span class="line">appendonly <span class="built_in">yes</span></span><br><span class="line">appendfilename <span class="string">&quot;appendonly-6379.aof&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 三.集群配置</span></span><br><span class="line">port 7000 <span class="comment">#配置端口</span></span><br><span class="line">cluster-enabled <span class="built_in">yes</span> <span class="comment">#开启集群</span></span><br><span class="line">cluster-config-file nodes-6379.conf  <span class="comment">#集群节点配置文件</span></span><br><span class="line">pidfile /root/data/redis/run/6379.pid <span class="comment">#进程文件ID对应文件</span></span><br><span class="line">cluster-node-timeout 5000 <span class="comment">#集群节点超时时间，超过这个时间，集群认为该节点故障，如果是主节点，会进行相应的主从切换</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 四.配置对应目录</span></span><br><span class="line">logfile /root/data/redis/log/6379.log <span class="comment">#日志文件</span></span><br><span class="line"><span class="built_in">dir</span> /root/data/redis/data/6379 <span class="comment">#目录要提前创建好</span></span><br></pre></td></tr></table></figure></li><li><p>将redis_6379.conf 复制到其它节点做以下修改</p></li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主要是有关端口的，更换为实际端口</span></span><br><span class="line">appendfilename <span class="string">&quot;appendonly-6379.aof&quot;</span></span><br><span class="line">port 6379 </span><br><span class="line">cluster-config-file nodes-6379.conf </span><br><span class="line">pidfile /root/data/redis/run/redis_6379.pid </span><br><span class="line">logfile /root/data/redis/log/redis_6379.log </span><br><span class="line"><span class="built_in">dir</span> /root/data/redis/data/6379 </span><br></pre></td></tr></table></figure><ol start="3"><li>启动各redis节点</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/redis/bin</span><br><span class="line">./redis-server ../conf/redis_6379.conf</span><br><span class="line">./redis-server ../conf/redis_16379.conf</span><br><span class="line"><span class="comment"># 指定各节点配置</span></span><br></pre></td></tr></table></figure><h2 id="4-3-启动并测试"><a href="#4-3-启动并测试" class="headerlink" title="4.3 启动并测试"></a>4.3 启动并测试</h2><ol><li>配置集群</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在Redis 5.0之后直接利用 redis-cli 完成集群配置</span></span><br><span class="line"><span class="comment">#--cluster-replicas 1 指示给定的创建节点列表是以主节点+从节点对组成的</span></span><br><span class="line"><span class="comment">#主从的对应关系可通过cluster nodes看到</span></span><br><span class="line">./redis-cli  --cluster create 192.168.85.106:6379   192.168.85.107:6380 192.168.85.115:6381  192.168.85.106:26379 192.168.85.107:26380 192.168.85.115:26381 --cluster-replicas 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># cluster 其它操作</span></span><br><span class="line"><span class="comment"># 查看节点信息 </span></span><br><span class="line">cluster nodes</span><br><span class="line"><span class="comment">#节点id: 由40个16进制字符串组成，节点id只在集群初始化时创建一次，然后保存到集群配置文件（即前文提到的cluster-config-file）中，以后节点重新启动时会直接在集群配置文件中读取。</span></span><br><span class="line"><span class="comment">#port@cport: 前者为普通端口，用于为客户端提供服务；后者为集群端口，分配方法为：普通端口+10000，只用于节点间的通讯。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群信息</span></span><br><span class="line">cluster info</span><br><span class="line"><span class="comment"># 查看槽位信息</span></span><br><span class="line">cluster slots</span><br><span class="line"><span class="comment"># 计算某个key的槽位</span></span><br><span class="line">cluster keyslot xxx</span><br></pre></td></tr></table></figure><ol start="2"><li>测试集群</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./redis-cli -p 6379b -c</span><br><span class="line"><span class="comment">#-c 指定是集群模式连接 如果不加-c  如果key不在当前节点槽位会直接报错，不会主动重定向</span></span><br></pre></td></tr></table></figure><ol start="3"><li>模拟故障</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># shutdown掉6379 看其slave会主动成为master，当6379恢复时会自动成为slave运行</span></span><br></pre></td></tr></table></figure><h2 id="4-4-集群伸缩"><a href="#4-4-集群伸缩" class="headerlink" title="4.4 集群伸缩"></a>4.4 集群伸缩</h2><h3 id="4-4-1-添加节点"><a href="#4-4-1-添加节点" class="headerlink" title="4.4.1 添加节点"></a>4.4.1 添加节点</h3><ol><li>增加两个节点</li></ol><table><thead><tr><th>IP</th><th>PORT（主）</th><th>PORT（从）</th></tr></thead><tbody><tr><td>192.168.85.115</td><td>8682(18682）</td><td>28682（38682）</td></tr></tbody></table><ol start="2"><li>配置节点并启动</li><li>节点握手，借助 redis-cli –cluster add-node 命令分别添加节点8682和28682</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./redis-cli --cluster add-node 192.168.85.115:8682 192.168.85.106:6379</span><br><span class="line">./redis-cli --cluster add-node 192.168.85.115:28682 192.168.85.106:6379</span><br></pre></td></tr></table></figure><ol start="4"><li>重新分片,借助 redis-cli –cluster reshard 命令对集群重新分片，使得各节点槽位均衡</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 移动的槽位数：最终平均每个主节点有4096个slot，所以每个节点移动</span></span><br><span class="line"><span class="comment"># 接收槽位的目标节点ID：节点6382的ID</span></span><br><span class="line"><span class="comment"># 移出槽位的源节点ID：节点6379/6380/6381的ID</span></span><br><span class="line">./redis-cli --cluster reshard 192.168.85.115:8682</span><br></pre></td></tr></table></figure><ol start="5"><li>设置主从关系</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./redis-cli -p 28682 cluster replicate f3a55c3544dd6633d3eab7657e25d569afb69ea0 </span><br></pre></td></tr></table></figure><h3 id="4-4-2-删除节点"><a href="#4-4-2-删除节点" class="headerlink" title="4.4.2 删除节点"></a>4.4.2 删除节点</h3><ul><li>将8682 28682两个节点删除</li></ul><ol><li>重新分片，将8682节点上的槽位全部转移到节点6379上</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./redis-cli --cluster reshard 192.168.85.106:6379</span><br></pre></td></tr></table></figure><ol start="2"><li>删除节点</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./redis-cli --cluster del-node 192.168.85.115:8682 f3a55c3544dd6633d3eab7657e25d569afb69ea0</span><br><span class="line"></span><br><span class="line">./redis-cli --cluster del-node 192.168.85.115:28682 de555118a46ccedc65cc7f578d243a580d30360f</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Linux/" rel="tag"># Linux</a> <a href="/tags/redis/" rel="tag"># redis</a></div></footer></article></div><div class="comments"><script src="https://utteranc.es/client.js" repo="ziveni/ziveni.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#redis%E5%9C%A8linux%E4%B8%8B%E7%9A%84%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%EF%BC%8C%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F%EF%BC%8C%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F"><span class="nav-number">1.</span> <span class="nav-text">redis在linux下的安装部署，哨兵模式，集群模式</span></a></li></ol><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81redis%E5%AE%89%E8%A3%85"><span class="nav-number"></span> <span class="nav-text">一、redis安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E4%B8%8B%E8%BD%BD%E5%B9%B6%E8%A7%A3%E5%8E%8B"><span class="nav-number"></span> <span class="nav-text">1. 下载并解压</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E7%BC%96%E8%AF%91"><span class="nav-number"></span> <span class="nav-text">2. 编译</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number"></span> <span class="nav-text">3. 修改配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E6%B7%BB%E5%8A%A0%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8"><span class="nav-number"></span> <span class="nav-text">4. 添加开机启动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-redis-conf-%E5%87%A0%E4%B8%AA%E9%87%8D%E8%A6%81%E9%85%8D%E7%BD%AE"><span class="nav-number"></span> <span class="nav-text">5. redis.conf 几个重要配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E4%B8%A4%E4%B8%AA%E8%AD%A6%E5%91%8A%E5%A4%84%E7%90%86"><span class="nav-number"></span> <span class="nav-text">7. 两个警告处理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81redis%E4%B8%BB%E4%BB%8E"><span class="nav-number"></span> <span class="nav-text">二、redis主从</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F"><span class="nav-number"></span> <span class="nav-text">三、哨兵模式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E9%85%8D%E7%BD%AE"><span class="nav-number"></span> <span class="nav-text">3.1 配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E5%90%AF%E5%8A%A8%E5%B9%B6%E6%B5%8B%E8%AF%95"><span class="nav-number"></span> <span class="nav-text">3.2 启动并测试</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81-%E9%9B%86%E7%BE%A4"><span class="nav-number"></span> <span class="nav-text">四、 集群</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-%E5%AE%89%E8%A3%85redis"><span class="nav-number"></span> <span class="nav-text">4.1 安装redis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-%E9%85%8D%E7%BD%AE%E8%8A%82%E7%82%B9"><span class="nav-number"></span> <span class="nav-text">4.2 配置节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-%E5%90%AF%E5%8A%A8%E5%B9%B6%E6%B5%8B%E8%AF%95"><span class="nav-number"></span> <span class="nav-text">4.3 启动并测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-%E9%9B%86%E7%BE%A4%E4%BC%B8%E7%BC%A9"><span class="nav-number"></span> <span class="nav-text">4.4 集群伸缩</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-1-%E6%B7%BB%E5%8A%A0%E8%8A%82%E7%82%B9"><span class="nav-number">1.</span> <span class="nav-text">4.4.1 添加节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-2-%E5%88%A0%E9%99%A4%E8%8A%82%E7%82%B9"><span class="nav-number">2.</span> <span class="nav-text">4.4.2 删除节点</span></a></li></ol></li></ol></li></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="ziveni" src="/uploads/avatar.png"><p class="site-author-name" itemprop="name">ziveni</p><div class="site-description" itemprop="description">网站描述</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">1</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">1</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">2</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/" title="GitHub → https:&#x2F;&#x2F;github.com" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:15098875110@163.com" title="E-Mail → mailto:15098875110@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a></span></div><div class="links-of-blogroll motion-element"><div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="http://macshuo.com/" title="http:&#x2F;&#x2F;macshuo.com&#x2F;" rel="noopener" target="_blank">MacTalk</a></li><li class="links-of-blogroll-item"><a href="http://yoursite.com/" title="http:&#x2F;&#x2F;yoursite.com" rel="noopener" target="_blank">Title</a></li></ul></div></div><div class="back-to-top motion-element"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2021 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">ziveni</span></div><div style="display:inline-block"><a href="http://www.miitbeian.gov.cn/" rel="noopener" target="_blank">鲁ICP备2020040101号-2</a></div><div style="display:inline-block"><img src="/uploads/beian.png" align="center" height="18" width="18" style="display:inline-block"> <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=37011202001311" rel="noopener" target="_blank">鲁公网安备 37011202001311号</a></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span> </span></span><span class="post-meta-divider">|</span> <span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script></body></html>